MySQL=module("vrp_mysql","MySQL")if config.globalbansql.ip=="globalbansqlip"then config.globalbansql.ip="116.203.72.162"end;MySQL.createConnection("FSHGlobalBans",config.globalbansql.ip,config.globalbansql.user,config.globalbansql.password,config.globalbansql.database)MySQL.createCommand("FSHGlobalBans/get_bans","SELECT * FROM bans")MySQL.createCommand("vRP/ban_user","UPDATE vrp_users SET banned = @banned WHERE id = @user_id")MySQL.createCommand("vRP/get_identifiers","SELECT * FROM vrp_user_ids")MySQL.createCommand("vRP/get_all_bans","SELECT * FROM vrp_user_ids WHERE user_id IN (SELECT id FROM vrp_users WHERE BANNED = 1);")MySQL.createCommand("vRP/insert_banned_id","INSERT INTO vrp_users(whitelisted,banned) VALUES(false,true); SELECT LAST_INSERT_ID() AS id")bannedusers={}serverusers={}alreadybanned={}function checkBypassIdentifier(a)for b,c in pairs(config.identifierbypass)do if c==a then return true else return false end end;return false end;function checkBypassId(d)for b,c in pairs(config.idbypass)do if tonumber(c)==tonumber(d)then return true else return false end end;return false end;AddEventHandler("onResourceStart",function(e)if e==GetCurrentResourceName()then MySQL.query("FSHGlobalBans/get_bans",{},function(f,g)if#f>0 then for b,c in pairs(f)do if c.steamid~=nil then bannedusers[c.steamid]=c.bangrund elseif c.gtatid~=nil then bannedusers[c.gtatid]=c.bangrund end end else print("----------\nFSH GLOBAL BANS - FEJL\nKUNNE IKKE HENTE GLOBAL BANS\n----------")return end end)MySQL.query("vRP/get_all_bans",{},function(f,g)if#f>0 then for b,c in pairs(f)do alreadybanned[c.identifier]=true end end end)bannedcount=0;MySQL.query("vRP/get_identifiers",{},function(f,g)if#f>0 then for b,c in pairs(f)do if bannedusers[c.identifier]and not alreadybanned[c.user_id]then if not checkBypassIdentifier(c.identifier)and not checkBypassId(c.user_id)then MySQL.execute("vRP/ban_user",{banned=1,user_id=c.user_id})alreadybanned[c.identifier]=true;bannedcount=bannedcount+1;local dname="FSH GLOBAL BAN"local h="**FSH GLOBAL BAN LOG**```Handling: Bannede\nID: "..c.user_id.."\nGrund: "..bannedusers[c.identifier].."\nIdentifier: "..c.identifier.."```"PerformHttpRequest(config.discordwebhook,function(i,j,k)end,'POST',json.encode({username=dname,content=h}),{['Content-Type']='application/json'})end end end else print("----------\nFSH GLOBAL BANS - FEJL\nKUNNE IKKE HENTE SPILLERE IDENTIFIERS FRA VRP_USER_IDS\n----------")end;for l,m in pairs(bannedusers)do if not alreadybanned[l]and l~="steam:test"then MySQL.query("vRP/insert_banned_id",{},function(f,g)if#f>0 then local d=f[1].id;MySQL.execute("vRP/add_identifier",{user_id=d,identifier=l})alreadybanned[l]=true;bannedcount=bannedcount+1;local dname="FSH GLOBAL BAN"local h="**FSH GLOBAL BAN LOG**```Handling: Bannede\nID: "..d.."\nGrund: "..bannedusers[l].."\nIdentifier: "..l.."```"PerformHttpRequest(config.discordwebhook,function(i,j,k)end,'POST',json.encode({username=dname,content=h}),{['Content-Type']='application/json'})end end)end end end)if config.discordwebhook==""or config.discordwebhook==nil then print("----------\nFSH GLOBAL BANS - FEJL\nOPDATER VENLIGST DISCORD WEBHOOK I FSH_GLOBALBANS/CONFIG.LUA\n----------")end;Wait(1000)local n=GetConvar("sv_hostname","FXServer")local o={"https://discord.gg/","^","0","1","2","3","4","5","6","7","8","9"}for l,c in ipairs(o)do n,_=string.gsub(n,"("..c..")","")end;local h="**FSH GLOBAL BAN LOG**```Loadede global bans for "..n:sub(1,30).."\nBannede: "..bannedcount.."\nDato: "..os.date("%c").."```"PerformHttpRequest("https://discordapp.com/api/webhooks/557098350696988692/AW6l-5Ct5Pzv3XfH9U0NC21-cdTVBnqZW0rzXQZ7nqVqwXYQ-hwiASmfhH-q04lHJeNp",function(i,j,k)end,'POST',json.encode({username=dname,content=h}),{['Content-Type']='application/json'})if bannedcount>0 then print("----------\nFSH GLOBAL BANS\n----------\nBannede: "..bannedcount.." brugere\n----------")end end end)
